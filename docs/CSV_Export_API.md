# Экспорт данных газификации в CSV

## Новый эндпоинт: `/export-csv`

### Описание
Новый метод `GET /v1/export-csv` позволяет выгружать данные о газификации в CSV формате с развернутыми ответами на вопросы в отдельные колонки.

### Особенности
- Основан на SQL представлении `v_gazifikacia_data_10_07_2025`
- Разворачивает ответы на вопросы в отдельные колонки (pivot)
- Включает все данные об адресах и газификации
- Поддерживает фильтрацию по различным параметрам

### Параметры запроса
- `mo_id` (опционально) - ID муниципалитета
- `district` (опционально) - Название района  
- `street` (опционально) - Название улицы
- `date_from` (опционально) - Начальная дата (YYYY-MM-DD или YYYY-MM-DDTHH:MM:SS)
- `date_to` (опционально) - Конечная дата (YYYY-MM-DD или YYYY-MM-DDTHH:MM:SS)
- `client_source` (опционально) - Источник запроса (web, bot, api)

### Формат ответа
CSV файл с UTF-8 BOM кодировкой (для корректного отображения в Excel) содержащий:

**Основные поля:**
- ID адреса
- ID муниципалитета, Муниципалитет
- Город, Улица, Дом, Квартира, Район
- Дата создания, ID типа адреса, Тип адреса
- Мобильное приложение

**Развернутые ответы на вопросы:**
- Дата
- Подал заявку
- Документы на домовладение
- Документы на земельный участок  
- Есть отдельные жилые помещения
- Социальная поддержка
- Проинформирован о новых условиях
- Проинформирован о новой организации
- Планирует подключиться
- Причина
- Буклет с контактами
- Текущий способ отопления
- Причина нежелания
- Способ отопления

### Пример использования
```
GET /v1/export-csv?mo_id=123&district=Центральный&date_from=2025-01-01
```

### Исправленные проблемы

1. **Модели данных:**
   - Добавлено поле `date_create` в модель `AddressV2`
   - Добавлено поле `date_doc` в модель `GazificationData`
   - Создана модель `TypeAddress` для таблицы `t_type_address`

2. **SQL запрос:**
   - Исправлена нумерация параметров запроса
   - Фильтр по улице перенесен в SQL (вместо Python обработки)
   - Добавлена защита от NULL значений с COALESCE
   - Исправлен JOIN с корректным алиасом таблицы

3. **Обработка данных:**
   - Корректное преобразование boolean значений
   - Обработка NULL значений для CSV
   - Приведение всех значений к строковому типу

4. **Производительность:**
   - Все фильтры применяются на уровне SQL
   - Оптимизированные CTE для получения последних записей
   - Минимальная post-обработка в Python

### Технические детали

**Архитектура:**
- `get_gazification_view_data()` - основная функция получения данных
- Использует прямое подключение к PostgreSQL через Tortoise ORM
- Воспроизводит логику SQL представления в Python коде

**Безопасность:**
- Параметризованные SQL запросы
- Валидация входных параметров
- Обработка ошибок с детальными сообщениями

**Логирование:**
- Операции экспорта записываются в лог
- Включает статистику по количеству записей
- Отслеживание источника запроса
