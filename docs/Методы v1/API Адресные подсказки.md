# API для работы с адресными подсказками

## Описание

Модуль адресных подсказок предоставляет API для работы с данными Государственного Адресного Реестра (ГАР). Он позволяет получать иерархические адресные данные для автозаполнения форм.

## Архитектура

### База данных
- **Основная БД**: `rkc_gazification` (Tortoise ORM)
- **БД адресов**: `addresses` (asyncpg, прямые PostgreSQL соединения)

### Подключение
Сервис использует отдельный пул соединений asyncpg для работы с базой данных addresses, что обеспечивает:
- Изоляцию от основной базы данных
- Высокую производительность запросов
- Возможность масштабирования

## Эндпоинты

### Базовый путь: `/v1/addresses`

### 1. Муниципальные образования
**GET** `/municipalities`

Получение списка муниципальных образований с группировкой схожих объектов.

**Параметры:**
- `search` (опционально) - поиск по названию
- `limit` (по умолчанию: 50) - лимит результатов (1-1000)
- `offset` (по умолчанию: 0) - смещение

**Особенности:**
- Группирует схожие административные единицы (г + г.о., р-н + м.о.)
- Возвращает объекты с уровнями 2,3,5,6 (районы, города, населенные пункты)

### 2. Улицы
**GET** `/streets`

Получение списка улиц для заданного муниципального образования.

**Параметры:**
- `municipality_id` (обязательно) - ID муниципального образования
- `search` (опционально) - поиск по названию улицы
- `limit`, `offset` - пагинация

**Особенности:**
- Возвращает объекты с уровнем 8 (Элемент улично-дорожной сети)

### 3. Дома
**GET** `/houses`

Получение списка домов для заданной улицы.

**Параметры:**
- `street_id` (обязательно) - ID улицы
- `search` (опционально) - поиск по номеру дома
- `limit`, `offset` - пагинация

**Особенности:**
- Автоматическое построение полного номера дома из частей
- Сортировка по числовому значению номера

### 4. Квартиры/помещения
**GET** `/apartments`

Получение списка квартир для заданного дома.

**Параметры:**
- `house_id` (обязательно) - ID дома
- `search` (опционально) - поиск по номеру квартиры
- `limit`, `offset` - пагинация

### 5. Комнаты
**GET** `/rooms`

Получение списка комнат для заданной квартиры.

**Параметры:**
- `apartment_id` (обязательно) - ID квартиры
- `search` (опционально) - поиск по номеру комнаты
- `limit`, `offset` - пагинация

### 6. Структура адресных данных
**GET** `/address-structure/{municipality_id}`

Определение структуры адресных данных для муниципального образования.

**Параметры:**
- `municipality_id` (в пути) - ID муниципального образования

**Возвращает:**
- Количество улиц
- Количество населенных пунктов
- Количество домов напрямую
- Флаги наличия городской/сельской структуры

### 7. Населенные пункты (сельские)
**GET** `/settlements`

Получение списка населенных пунктов (деревни, села, СНТ).

**Параметры:**
- `municipality_id` (обязательно) - ID административной единицы
- `search` (опционально) - поиск по названию
- `limit`, `offset` - пагинация

### 8. Сельские дома
**GET** `/rural-houses`

Получение списка домов в населенном пункте (без привязки к улице).

**Параметры:**
- `settlement_id` (обязательно) - Object ID населенного пункта
- `search` (опционально) - поиск по номеру дома
- `limit`, `offset` - пагинация

### 9. Проверка здоровья
**GET** `/health`

Проверка состояния сервиса и базы данных addresses.

## Формат ответов

Все эндпоинты возвращают данные в едином формате:

```json
{
  "ok": true,
  "message": "Успех",
  "data": {
    "total": 100,
    "items": [...]
  }
}
```

## Конфигурация

### Переменные окружения
```env
# Основная база данных (Tortoise ORM)
DATABASE_URL=postgres://postgres:password@localhost:5432/rkc_gazification

# База данных адресов (asyncpg)
ADDRESSES_DATABASE_URL=postgres://postgres:password@localhost:5432/addresses
```

### Пул соединений
- Минимум соединений: 2
- Максимум соединений: 10
- Автоматическая инициализация при старте приложения
- Корректное закрытие при завершении

## Логирование

Все операции логируются с помощью встроенной системы логирования:
- Успешные операции: уровень INFO
- Ошибки: уровень ERROR
- Категоризация по типам операций

## Использование

### Типичный сценарий (городской адрес):
1. `GET /municipalities` - получить список городов/районов
2. `GET /streets?municipality_id=X` - получить улицы в выбранном городе
3. `GET /houses?street_id=Y` - получить дома на улице
4. `GET /apartments?house_id=Z` - получить квартиры в доме
5. `GET /rooms?apartment_id=W` - получить комнаты в квартире

### Типичный сценарий (сельский адрес):
1. `GET /municipalities` - получить список районов
2. `GET /address-structure/{municipality_id}` - проверить структуру
3. `GET /settlements?municipality_id=X` - получить населенные пункты
4. `GET /rural-houses?settlement_id=Y` - получить дома в селе

## Особенности реализации

### Производительность
- Использование индексов базы данных для быстрого поиска
- Оптимизированные SQL-запросы с JOIN'ами
- Пагинация для больших результатов

### Надежность
- Обработка ошибок с детализированными сообщениями
- Валидация входных параметров
- Проверка существования связанных объектов

### Масштабируемость
- Отдельный пул соединений для адресной базы
- Возможность горизонтального масштабирования
- Кэширование на уровне базы данных
